## Script_for_crop
Скрипт анализирует JSON-файлы с метаданными (координаты обнаруженных объектов, уверенность модели),
находит соответствующие видеофайлы, и сохраняет изображения обнаруженных объектов в виде кропов.

#### Структура данных
    Входные данные:
      Папка json_final с JSON-файлами (вложенные в папки вида <класс_животного>_json)
      Папка all_videos с видеофайлами (.mp4, .avi, .mov)
    
    Выходные данные:
        Папка results_crop с кропами, сгруппированными по классам животных и исходным видео

#### Логика работы
#### Логика работы

1. **Кэширование видеофайлов**:
   - Скрипт создаёт кеш путей к видеофайлам из папки `all_videos` для ускорения поиска.

2. **Извлечение данных**:
   - Класс животного извлекается из названия родительской папки JSON-файла (например, `Alces_json` → `Alces`).
   - Видео находится по точному совпадению имени файла с именем JSON (без расширения).

3. **Обработка кадров**:
   - Переход к кадрам, указанным в JSON.
   - Фильтрация детекций по порогу уверенности (`CONFIDENCE_THRESHOLD = 0.9`).
   - Вычисление координат bounding box и преобразование относительных координат в абсолютные.
   - Проверка границ кадра.
   - Фильтрация по минимальному размеру кропа (`MIN_SIZE_FOR` или `DEFAULT_MIN_SIZE_RATIO = 0.04`).
   - Проверка соотношения сторон кропа (максимум 5:1).
   - Проверка уникальности кропа с использованием IoU (Intersection over Union) с порогами (`IOU_THRESHOLDS` или `DEFAULT_IOU_THRESHOLD = 0.7`).
   - Ограничение дубликатов через историю кропов (`MAX_HISTORY_SIZE = 150`).
   - Сохранение кропов в формате JPG через библиотеку PIL.

4. **Ограничение интервала кадров**:
   - Между обрабатываемыми кадрами соблюдается минимальный интервал (`MIN_INTERVAL_SECONDS = 0.5 сек`).

5. **Многопоточная обработка**:
   - JSON-файлы обрабатываются параллельно с использованием `ThreadPoolExecutor` (максимум потоков: половина числа CPU).
#### Используемые параметры
- `CONFIDENCE_THRESHOLD = 0.9`: порог уверенности для детекций.
- `IOU_THRESHOLDS`: пороги IoU для классов животных (`Bison: 0.6`, `Sus: 0.6`, `Capreolus: 0.65`, `Nyctereutes: 0.65`, по умолчанию: `0.7`).
- `MIN_SIZE_FOR`: минимальный размер кропа для классов (`Bison: 0.06`, `Sus: 0.06`, по умолчанию: `0.04`).
- `MIN_INTERVAL_SECONDS = 0.5`: минимальный интервал между кадрами.
- `MAX_HISTORY_SIZE = 150`: максимальный размер истории кропов для исключения дубликатов.
- `VIDEO_EXTENSIONS = ('.mp4', '.avi', '.mov')`: поддерживаемые форматы видео.

#### Структура результата
    results_crop/
      ├── Alces/
      │   ├── video1_frame_000001_det_000.jpg
      │   ├── video1_frame_000002_det_001.jpg
      │   └── video2_frame_000005_det_000.jpg
      └── Bison/
          ├── video3_frame_000010_det_000.jpg
          └── video4_frame_000015_det_001.jpg
